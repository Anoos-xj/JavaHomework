## 项目概览
- 技术栈：Java 8+、MySQL、JDBC（`lib/mysql-connector-j-8.3.0.jar`）
- 现状：已具备多线程服务器与基础客户端/文件读写示例、MySQL连接测试（`DBTest.java:13-21`）。
- 目标：完善并联通“4客户端并发 → 服务器保存到本地文件与MySQL → 文件与数据库两种方式展示”的完整闭环。 

## 架构设计
- 进程：1个服务器程序 + 4个独立客户端程序。
- 通信：TCP/IP，面向连接，每个连接由独立服务线程处理（参考 `test/test/MultiThreadServer.java:12-23`）。
- 数据模型：`Ticket`（姓名、身份证、出发城市、到达城市），行格式统一为逗号分隔（参考 `test/test/Ticket.java:52-55`）。
- 存储：服务器本地文件 `server_all_records.txt` 与 MySQL 表 `tickets` 同步保存。
- 配置：新增 `db.properties` 管理数据库连接参数；新增 SQL 脚本初始化表结构。

## 通信实现
- 保留并使用 `MultiThreadServer` + `ClientHandler`：
  - 服务器监听 `8888`，为每个客户端 `accept` 启动新线程（`test/test/MultiThreadServer.java:12-23`）。
  - 每线程完成一次票据处理：读取对象 → 保存文件 → 写入数据库 → 回复（目前已有文件保存与回复，`test/test/ClientHandler.java:23-34`）。
- 客户端程序（4个）：每个客户端从本地文件读取多条票据，逐条建立短连接发送一个 `Ticket` 对象，读取回复后关闭连接，支持并行运行以触发并发。

## 客户端文件读取
- 复用并增强 `FileManager.readTicketsFromFile`（`test/test/FileManager.java:8-20`）读取逗号分隔的 `tickets.txt` 等文件。
- 规划 4 个客户端：`FileClient1`、`FileClient2`、`FileClient3`、`FileClient4`，分别读取 `client1_tickets.txt`…`client4_tickets.txt`，内容格式与 `Ticket.toString` 保持一致。

## 服务器文件存储
- 保留 `ServerFileHelper.saveRecord` 以确保并发安全的追加写（`test/test/ServerFileHelper.java:7` 为 `synchronized`）。
- 统一服务器文件为 `server_all_records.txt`，每行 1 条票据，逗号分隔，末行自动换行处理（已实现）。

## 数据库设计与同步
- 新增 `DatabaseHelper`：
  - 负责加载 `db.properties`，初始化 JDBC 驱动，提供获取连接与安全关闭的工具方法。
  - 通过 `PreparedStatement` 写入，确保线程安全与数据一致性（每线程独立连接或连接短生命周期）。
- 表结构：`tickets(id BIGINT AUTO_INCREMENT PRIMARY KEY, name VARCHAR(64), id_card VARCHAR(32), start_city VARCHAR(64), end_city VARCHAR(64), created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP)`。
- 新增 `sql/create_tickets.sql`：包含数据库与表的创建脚本以及必要索引。
- 在 `ClientHandler.run()` 中于文件保存后调用数据库写入（保持“文件与数据库”一致性；失败时记录错误但不影响线程与后续请求）。

## 显示功能
- 文件数据显示：新增 `DisplayServerFile`，读取 `server_all_records.txt`，以对齐列宽在控制台展示完整字段。
- 数据库数据显示：新增 `DisplayDatabase`，查询 `tickets` 全量数据，使用固定列宽格式化输出，确保与文件数据一致。

## 配置与脚本
- 新增 `db.properties`（示例键：`url`、`user`、`password`、`database`）。
- 新增 `sql/create_tickets.sql`：
  - 创建数据库（如 `train_tickets`）。
  - 创建 `tickets` 表。
  - 可选：唯一性约束组合（如 `name`+`id_card`+`start_city`+`end_city`）或保留重复以模拟业务真实情况。

## 并发与线程安全
- 服务器端：
  - 每连接独立线程（`MultiThreadServer`）。
  - 文件写入使用类级 `synchronized`（`ServerFileHelper.saveRecord`）。
  - 数据库写入使用短连接 + `PreparedStatement`，避免共享可变状态。
- 客户端端：
  - 每条记录使用短连接，天然避免流协议复杂度与粘包问题。

## 异常处理与健壮性
- 客户端：读取文件异常、网络异常均打印错误并跳过问题记录。
- 服务器：文件与数据库异常分别捕获与记录，保持线程不崩溃、连接正确关闭。
- 数据一致性：先文件后数据库；数据库失败不影响文件记录，可在展示时对比差异。

## 测试与演示步骤
- 数据库准备：使用 `DBTest.java`验证驱动与密码（`DBTest.java:7-10,13-21`），执行 `sql/create_tickets.sql` 初始化数据库。
- 启动服务器：运行 `MultiThreadServer`。
- 并发演示：并行运行 4 个 `FileClientX`，各自发送多条记录；服务器端控制台显示连接与处理日志。
- 文件展示：运行 `DisplayServerFile`，查看 `server_all_records.txt` 的所有记录。
- 数据库展示：运行 `DisplayDatabase`，查看 `tickets` 表全部记录（表格对齐）。

## 交付物清单
- 完整源代码：服务器、4个客户端、显示程序、数据库辅助。
- 数据库建表脚本：`sql/create_tickets.sql`。
- 配置文件：`db.properties`（不含敏感信息示例，实际密码由使用者配置）。
- 使用说明：运行顺序、配置项、演示要点。

## 涉及代码改动与新增文件
- 保留并复用：
  - `test/test/MultiThreadServer.java`、`test/test/ClientHandler.java`、`test/test/ServerFileHelper.java`、`test/test/Ticket.java`、`test/test/FileManager.java`。
- 新增：
  - `test/test/DatabaseHelper.java`（JDBC封装 + `db.properties`加载）。
  - `test/test/DisplayServerFile.java`、`test/test/DisplayDatabase.java`（展示）。
  - `test/test/FileClient1.java`、`test/test/FileClient2.java`、`test/test/FileClient3.java`、`test/test/FileClient4.java`（4个客户端）。
  - `db.properties`（根目录或 `test/test/` 相对路径一致）。
  - `sql/create_tickets.sql`（数据库初始化脚本）。

## 验收对齐（评分点映射）
- 通信功能：4客户端并发连接、每连接独立服务线程、稳定TCP/IP、线程安全（文件写入 + JDBC）。
- 记录功能：客户端从本地文件读取；服务器保存到本地文件，格式统一。
- 数据库功能：MySQL配置、合理表结构、同步写入、数据一致性与完整性（非空校验 + 类型合理）。
- 显示功能：本地文件与数据库分别展示，字段完整，对齐清晰。

请确认以上计划，确认后我将开始按此方案实现、联调与自测。